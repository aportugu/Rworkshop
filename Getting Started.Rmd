---
title: "Getting Started with R"
subtitle: "In the first session, you'll learn how to install R and RStudio, create and work with an R Markdown file, install and load critical libraries, and generate summary tables and histograms."
author: "Andrew Portuguese"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  distill::distill_article:
    code_folding: true
    toc: true
    toc_float: true
    self_contained: true
---

# 1. Download R and RStudio Desktop

## 1a. RStudio Desktop is an integrated development environment to help you be more productive with R.

## 1b. R and RStudio can both be downloaded here: https://posit.co/download/rstudio-desktop/

## 1c. Go through a typical installation with all the default settings.

# 2. Install critical packages by entering the following code in the Console

## 2a. Install "readxl" in order to get data out of Excel and into R
```{r}
## Note: delete the ##'s

## install.packages("readxl")
```
## 2b. Install "gtsummary" to easily create publication-ready analytical and summary tables.
```{r}
## Note: delete the ##'s

## install.packages("gtsummary")
```

## 2c. Install "ggplot2" to create graphics and plots.
```{r}
## Note: delete the ##'s

## install.packages("ggplot2")
```

## 2d. Install "dplyr" to manipulate data sets (i.e., add new variables, filter, summarize, arrange).
```{r}
## Note: delete the ##'s

## install.packages("dplyr")
```

# 3. Create an R Markdown document. File -> New File -> R Markdown.

## 3a. You can then add your code within a "chunk" (click on the +c icon and select "R"). You can then run the code within the chunk by pressing the right-facing green arrow.
```{r}
## This is a chunk.

## Code can be placed inside here.

## You can silence warnings and messages : {r, warning=FALSE, message=FALSE}
```


## 3b. Open the necessary libraries to read in data, create data tables, and generate plots.
```{r}
library(readxl)
library(gtsummary)
library(ggplot2)
library(dplyr)
```

## 3c. Test out ggplot2 by making a scatterplot using the built-in "mtcars" data set. We are plotting miles per gallon vs weight, and a third variable, number of cylinders is represented by color.
```{r}
quickplot(x = mpg, y = wt, data = mtcars, colour = cyl)
```

# 4. Read in your data!

## 4a. First try reading in a dataset in a csv file.
```{r}
db = read.csv(file="sample.data.csv",header = TRUE, sep = ",") ## Read the csv file into a dataframe

## head(db) ## Can use the head function to take a look at the first few patients in the dataset
```
## 4b. Next try reading in a dataset in an xlsx file.
```{r}
db = read_excel(path="sample.data.xlsx")

## NOTE: If the data file is outside the folder of the R markdown file, then the path must include directions to the file
## For example: "/Users/aportugu/Desktop/sample.data.xlsx"

##head(db)

## NOTE: for dates to read in correctly, there CANNOT be any "NA" entries
```

# 5. Make customized data tables.

## 5a. Create a simple data table of baseline characteristics.
```{r}
theme_gtsummary_compact() ## Set table theme to compact

temp.table.data <- db %>% ## Create the characteristics you want to include in your table.
  transmute(
    "Age (years)" = Age,
    "Male sex" = ifelse(Sex == "M", "Yes","No"),
    "HCT-CI" = HCT.CI,
    "Disease subtype" = Disease,
    "Largest lesion (cm)" = Largest.lesion,
    "Bulky (\u22655 cm)" = ifelse(Bulky == 1, "Yes","No"),
    "Extranodal" = ifelse(Extranodal == 1, "Yes","No"),
    "Product" = factor(recode(CAR.T.Product.Type, "Breyanzi"= "Liso-cel", "Yescarta" = "Axi-cel"), levels = c("Liso-cel","Axi-cel"))
  ) 

temp.table.data %>% ## Make your table
  tbl_summary(
    missing = "no",
    type = c("HCT-CI" = "continuous"),
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})", ## Continuous variables are described as median with IQR
      all_categorical() ~ "{n} ({p}%)", ## Categorical variables are counted and given a percentage
      "Age (years)" ~"{median} ({min} to {max})" ## Age (a continuous variable) is listed as median with min to max
    )
  ) %>%
  bold_labels %>% ## Add bold labels
  add_stat_label() ## Add the statistic (i.e., median with IQR)
```

## 5b. Stratify the characteristics based on CAR-T products, Liso-cel and Axi-cel
```{r}
theme_gtsummary_compact() ## Set table theme to compact

db %>% ## Create the characteristics you want to include in your table.
  transmute(
    "Age (years)" = Age,
    "Male sex" = ifelse(Sex == "M", "Yes","No"),
    "HCT-CI" = HCT.CI,
    "Disease subtype" = Disease,
    "Largest lesion (cm)" = Largest.lesion,
    "Bulky (\u22655 cm)" = ifelse(Bulky == 1, "Yes","No"),
    "Extranodal" = ifelse(Extranodal == 1, "Yes","No"),
    "Product" = factor(recode(CAR.T.Product.Type, "Breyanzi"= "Liso-cel", "Yescarta" = "Axi-cel"), levels = c("Liso-cel","Axi-cel"))
  ) %>% ## Make your table
  tbl_summary(
    by = "Product",
    missing = "no",
    type = c("HCT-CI" = "continuous"),
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})", ## Continuous variables are described as median with IQR
      all_categorical() ~ "{n} ({p}%)", ## Categorical variables are counted and given a percentage
      "Age (years)" ~"{median} ({min} to {max})" ## Age (a continuous variable) is listed as median with min to max
    )
  ) %>%
  bold_labels %>% ## Add bold labels
  add_stat_label() ## Add the statistic (i.e., median with IQR)
```

## 5c. Compare baseline characteristics and include p-values
```{r}
theme_gtsummary_compact() ## Set table theme to compact

db %>% ## Create the characteristics you want to include in your table.
  transmute(
    "Age (years)" = Age,
    "Male sex" = ifelse(Sex == "M", "Yes","No"),
    "HCT-CI" = HCT.CI,
    "Disease subtype" = Disease,
    "Largest lesion (cm)" = Largest.lesion,
    "Bulky (\u22655 cm)" = ifelse(Bulky == 1, "Yes","No"),
    "Extranodal" = ifelse(Extranodal == 1, "Yes","No"),
    "Product" = factor(recode(CAR.T.Product.Type, "Breyanzi"= "Liso-cel", "Yescarta" = "Axi-cel"), levels = c("Liso-cel","Axi-cel"))
  ) %>% ## Make your table
  tbl_summary(
    by = "Product",
    missing = "no",
    type = c("HCT-CI" = "continuous"),
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})", ## Continuous variables are described as median with IQR
      all_categorical() ~ "{n} ({p}%)", ## Categorical variables are counted and given a percentage
      "Age (years)" ~"{median} ({min} to {max})" ## Age (a continuous variable) is listed as median with min to max
    )
  ) %>%
  bold_labels %>%
  add_p() %>%
  add_stat_label()
```

# 6. Make histograms.

## 6a. Use a simple histogram to quickly visualize the distribution of ages.
```{r}
hist(db$Age) ## Use the hist function
```

## 6b. Add axis labels
```{r}
hist(db$Age,
     main = "Histogram of Ages",
     xlab = "Age (years)",
     ylab = "Count")
```


## 6c. Make the histogram using ggplot to gain customizability.
```{r}
db %>%
  ggplot( aes(x=Age))  + ## Pass the Ages as an aesthetic mapping to the ggplot function
  geom_histogram(fill = "gray", color="black", bins = 12) + ## Plot a histogram
  theme_classic() + ## Use a classic theme
  xlab("Age (years)") ## Label the x axis
```

## 6d. Stratify the histogram by product type.
```{r}
db %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type,"Breyanzi" = "Liso-cel","Yescarta" = "Axi-cel")
    )%>% ## Recode the product type by the generic names
  ggplot( aes(x=Age, fill=CAR.T.Product.Type) )  + ## Fill in
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity', bins = 24) +
    scale_fill_manual(values=c("#69b3a2", "#404080")) +
    theme_minimal() +
    labs(fill="") + 
  xlim(0, 85)+ ## Set the limits of the histogram x axis
  xlab("Age (years)")
```

## 6e. Add median lines to visualize the difference in age.
```{r}
db %>%
  mutate(
    CAR.T.Product.Type = recode(CAR.T.Product.Type,"Breyanzi" = "Liso-cel","Yescarta" = "Axi-cel")
    )%>% ## Recode the product type by the generic names
  ggplot( aes(x=Age, fill=CAR.T.Product.Type) )  + ## Fill in
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity', bins = 24) +
    scale_fill_manual(values=c("#69b3a2", "#404080")) +
    theme_minimal() +
    labs(fill="") + 
  geom_vline(aes(xintercept = median(as.numeric(filter(db, CAR.T.Product.Type == "Yescarta")$Age))),
             linetype = "dashed", color = "#69b3a2", linewidth = 0.75)+ 
  geom_vline(aes(xintercept = median(as.numeric(filter(db, CAR.T.Product.Type == "Breyanzi")$Age))),
             linetype = "dashed", color = "#404080", linewidth = 0.75) +
  xlim(0, 85)+ ## Set the limits of the histogram x axis
  xlab("Age (years)")
```
